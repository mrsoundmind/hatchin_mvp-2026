# Phase 1 Invariants

**Last Updated**: 2025-12-26  
**Status**: Enforced

This document defines the non-negotiable invariants for Phase 1 of the Hatchin system. These invariants must be maintained across all future changes.

---

## Core Invariants

### 1. Routing Invariant

**Statement**: Newly created projects must land in PROJECT scope by default. No auto agent selection after creation unless the user explicitly selects an agent.

**Enforcement Location**:
- `client/src/pages/home.tsx` → `handleEggHatchingComplete()` (line ~278-281)
- `client/src/pages/home.tsx` → `handleCreateProject()` (line ~133-135)

**Canonical Behavior**:
```typescript
// After project creation:
setActiveProjectId(newProject.id);
setActiveTeamId(null);
setActiveAgentId(null); // Must be null, not mayaAgent.id
```

**Violation Detection**: If `activeAgentId` is set after project creation, routing invariant is violated.

---

### 2. Persistence Invariant

**Statement**: If the user can send, the system must persist both user + agent responses deterministically (including fallbacks).

**Enforcement Location**:
- `server/routes.ts` → `handleStreamingColleagueResponse()` (line ~1180-1450)
- `server/storage.ts` → `addMessage()` (line ~650)

**Canonical Behavior**:
- User messages are always persisted before `handleStreamingColleagueResponse` is called
- Agent messages are always persisted, even if:
  - No agents are available in scope
  - Authority resolution fails
  - Orchestration fails
- Early returns that prevent persistence are forbidden

**Violation Detection**: If `storage.addMessage()` is not called for a user or agent message, persistence invariant is violated.

---

### 3. Conversation Existence Invariant

**Statement**: Before saving any message, the conversation record must exist (project/team/agent canonical IDs).

**Enforcement Location**:
- `server/routes.ts` → `handleStreamingColleagueResponse()` → `ensureConversationExists()` (line ~1050-1100)
- `server/routes.ts` → `POST /api/projects` → Project conversation bootstrap (line ~73-96)

**Canonical Conversation IDs**:
- Project: `project-{projectId}`
- Team: `team-{projectId}-{teamId}`
- Agent: `agent-{projectId}-{agentId}`

**Canonical Behavior**:
- `ensureConversationExists()` is called at the start of `handleStreamingColleagueResponse` for all scopes
- Project conversations are created during project creation (`POST /api/projects`)
- Conversation creation is idempotent (no errors if already exists)

**Violation Detection**: If `storage.addMessage()` is called with a `conversationId` that doesn't exist in `storage.conversations`, conversation existence invariant is violated.

---

### 4. No Fake "System Agent" Invariant

**Statement**: If a fallback speaker is needed, prefer a real PM (Maya) when project has agents; only use a true system-type message when the project truly has zero agents, and it must be explicitly marked as such.

**Enforcement Location**:
- `server/routes.ts` → `handleStreamingColleagueResponse()` → `getProjectPmFallback()` (line ~1200-1230)
- `server/routes.ts` → `handleStreamingColleagueResponse()` → System fallback logic (line ~1250-1280)

**Canonical Behavior**:
- If agents exist in project → use PM Maya fallback (`agentId = pmAgent.id`, `messageType = 'agent'`)
- If zero agents in project → use system fallback (`agentId = null`, `messageType = 'system'`, `metadata.fallback.type = 'system'`)
- Never create a fake "System" agent with `agentId = 'system'` and `messageType = 'agent'`

**Violation Detection**: If a message has `agentId = 'system'` and `messageType = 'agent'`, the invariant is violated.

---

### 5. Dev Logs Must Never Leak to Production

**Statement**: Dev logs must never leak to production.

**Enforcement Location**:
- `client/src/lib/devLog.ts` → `devLog()` function (line ~10-60)

**Canonical Behavior**:
- `devLog()` must NO-OP unless `UI_AUDIT_ENABLED` is true
- `UI_AUDIT_ENABLED` must be `false` in production builds
- Dev logs must be tree-shaken / dead code in production (no console styling or payload processing)

**Violation Detection**: If `devLog()` executes in production builds or logs appear in production console, the invariant is violated.

---

## Canonical Conversation ID Formats

All conversation IDs must follow these exact formats:

- **Project**: `project-{projectId}`
  - Example: `project-saas-startup`
  - Generated by: `buildConversationId('project', projectId)`

- **Team**: `team-{projectId}-{teamId}`
  - Example: `team-saas-startup-design-team`
  - Generated by: `buildConversationId('team', projectId, teamId)`

- **Agent**: `agent-{projectId}-{agentId}`
  - Example: `agent-saas-startup-maya`
  - Generated by: `buildConversationId('agent', projectId, agentId)`

**Enforcement**: All conversation ID generation must use `shared/conversationId.ts` → `buildConversationId()`. All parsing must use `parseConversationId()`.

---

## Invariant Enforcement Summary

| Invariant | Primary Enforcement | Secondary Checks |
|-----------|---------------------|------------------|
| Routing | `home.tsx` post-create selection | `CenterPanel.tsx` chat context computation |
| Persistence | `routes.ts` handleStreamingColleagueResponse | `storage.ts` addMessage |
| Conversation Existence | `routes.ts` ensureConversationExists | `routes.ts` POST /api/projects |
| No Fake System Agent | `routes.ts` getProjectPmFallback | `routes.ts` system fallback logic |
| Dev Logs Production Safety | `devLog.ts` UI_AUDIT_ENABLED gate | Build-time tree-shaking |

---

## Related Files

- `shared/conversationId.ts` - Canonical conversation ID contract
- `server/routes.ts` - Backend invariant enforcement
- `server/storage.ts` - Persistence layer
- `client/src/pages/home.tsx` - Frontend routing
- `client/src/components/CenterPanel.tsx` - Chat context computation
- `client/src/lib/devLog.ts` - Dev logging utility

---

**Note**: These invariants are non-negotiable. Any code changes that violate these invariants must be rejected or fixed before merging.

